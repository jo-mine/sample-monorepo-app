#!/bin/bash
# Excel設計書をMarkdownに変換するスクリプト
# 使用方法: ./excel-to-markdown.sh <Excelファイルパス>
#
# 処理概要:
#   1. LibreOfficeでExcel → PDF変換
#   2. pdftoppmでPDF → PNG画像（ページ毎）変換
#   3. 生成された画像パスを標準出力に出力する
#      → エージェントが画像を視覚的に解析してMarkdownを生成する

set -euo pipefail

# ---------------------------------------------------------------------------
# 引数チェック
# ---------------------------------------------------------------------------
if [ $# -lt 1 ]; then
    echo "使用方法: $0 <Excelファイルパス>" >&2
    exit 1
fi

INPUT_FILE="$1"

# ---------------------------------------------------------------------------
# 入力ファイルの存在確認
# ---------------------------------------------------------------------------
if [ ! -f "$INPUT_FILE" ]; then
    echo "エラー: ファイルが存在しません: $INPUT_FILE" >&2
    exit 1
fi

# ---------------------------------------------------------------------------
# 拡張子チェック
# ---------------------------------------------------------------------------
case "$INPUT_FILE" in
    *.xlsx|*.xls)
        ;;
    *)
        echo "エラー: サポートされていないファイル形式です（.xlsx または .xls のみ対応）: $INPUT_FILE" >&2
        exit 1
        ;;
esac

# ---------------------------------------------------------------------------
# LibreOfficeの存在確認
# ---------------------------------------------------------------------------
if ! command -v libreoffice &> /dev/null; then
    echo "エラー: LibreOfficeがインストールされていません。" >&2
    echo "インストール方法（Debian/Ubuntu）: sudo apt-get install -y libreoffice" >&2
    exit 1
fi

# ---------------------------------------------------------------------------
# pdftoppmの存在確認
# ---------------------------------------------------------------------------
if ! command -v pdftoppm &> /dev/null; then
    echo "エラー: pdftoppmがインストールされていません。" >&2
    echo "インストール方法（Debian/Ubuntu）: sudo apt-get install -y poppler-utils" >&2
    exit 1
fi

# ---------------------------------------------------------------------------
# プロジェクトルートを自動検出
# ---------------------------------------------------------------------------
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# ---------------------------------------------------------------------------
# 出力ディレクトリの作成
# ---------------------------------------------------------------------------
WORK_DIR="${PROJECT_ROOT}/.github/work"
mkdir -p "$WORK_DIR"

# ---------------------------------------------------------------------------
# ファイル名（拡張子なし）を取得
# ---------------------------------------------------------------------------
BASENAME="$(basename "$INPUT_FILE")"
FILENAME="${BASENAME%.*}"

PDF_OUTPUT="${WORK_DIR}/${FILENAME}.pdf"
MD_OUTPUT="${WORK_DIR}/${FILENAME}.md"
IMAGE_PREFIX="${WORK_DIR}/${FILENAME}"

# ---------------------------------------------------------------------------
# LibreOfficeでExcel → PDF変換
# ---------------------------------------------------------------------------
echo "ExcelファイルをPDFに変換中: $INPUT_FILE"
if ! libreoffice --headless --convert-to pdf --outdir "$WORK_DIR" "$INPUT_FILE"; then
    echo "エラー: PDF変換に失敗しました: $INPUT_FILE" >&2
    exit 1
fi

# 変換後のPDFが存在するか確認
if [ ! -f "$PDF_OUTPUT" ]; then
    echo "エラー: PDFファイルが生成されませんでした: $PDF_OUTPUT" >&2
    exit 1
fi

echo "PDF変換完了: $PDF_OUTPUT"

# ---------------------------------------------------------------------------
# pdftoppmでPDF → PNG画像（ページ毎）変換
# 解像度150dpiで各ページをPNG画像として出力する
# ---------------------------------------------------------------------------
echo "PDFをページ画像に変換中..."
if ! pdftoppm -png -r 150 "$PDF_OUTPUT" "$IMAGE_PREFIX"; then
    echo "エラー: PDF→画像変換に失敗しました: $PDF_OUTPUT" >&2
    exit 1
fi

# ---------------------------------------------------------------------------
# 生成された画像ファイル一覧を取得して標準出力に出力する
# エージェントがこれらの画像を視覚的に解析してMarkdownを生成する
# ---------------------------------------------------------------------------
IMAGE_FILES=()
while IFS= read -r -d '' img; do
    IMAGE_FILES+=("$img")
done < <(find "$WORK_DIR" -name "${FILENAME}-*.png" -print0 | sort -z)

if [ ${#IMAGE_FILES[@]} -eq 0 ]; then
    echo "エラー: ページ画像が生成されませんでした。" >&2
    exit 1
fi

echo "ページ画像の生成完了: ${#IMAGE_FILES[@]}ページ"

# 出力先Markdownパスと生成画像パス一覧を標準出力に出力する
echo "MARKDOWN_OUTPUT=${MD_OUTPUT}"
for img in "${IMAGE_FILES[@]}"; do
    echo "PAGE_IMAGE=${img}"
done
